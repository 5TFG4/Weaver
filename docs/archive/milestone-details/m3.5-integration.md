# M3.5: Integration Fixes

> **Status**: ⏳ NEXT  
> **Prerequisite for**: M4 (Greta)  
> **Estimated Effort**: 6-8 hours

---

## Part A: Full Design

### A.1 Problem Statement

Routes create module-level singletons instead of using services from app.state. This means:
- Services are disconnected from Database, EventLog, VedaService
- No events flow through the system
- SSE is effectively dead

### A.2 Target Architecture

```
Request → Route → Depends(get_service) → app.state.service → Response
                                              ↓
                                         EventLog.append()
                                              ↓
                                         SSEBroadcaster
```

### A.3 Dependencies Module Design

```python
# src/glados/dependencies.py

from fastapi import Request
from src.events import EventLog
from src.veda import VedaService
from .services.run_manager import RunManager

def get_run_manager(request: Request) -> RunManager:
    return request.app.state.run_manager

def get_veda_service(request: Request) -> VedaService:
    return request.app.state.veda_service

def get_event_log(request: Request) -> EventLog:
    return request.app.state.event_log

def get_broadcaster(request: Request) -> SSEBroadcaster:
    return request.app.state.broadcaster
```

### A.4 Route Migration Pattern

**Before** (module singleton):
```python
_run_manager: RunManager | None = None

def get_run_manager() -> RunManager:
    global _run_manager
    if _run_manager is None:
        _run_manager = RunManager()
    return _run_manager

@router.post("/runs")
async def create_run(request: RunCreate):
    manager = get_run_manager()
    return await manager.create(request)
```

**After** (dependency injection):
```python
from src.glados.dependencies import get_run_manager

@router.post("/runs")
async def create_run(
    request: RunCreate,
    manager: Annotated[RunManager, Depends(get_run_manager)],
):
    return await manager.create(request)
```

### A.5 Event Emission Design

Services emit events on state changes:

```python
class RunManager:
    def __init__(self, event_log: EventLog | None = None):
        self._event_log = event_log
    
    async def create(self, request: RunCreate) -> Run:
        run = Run(...)
        self._runs[run.id] = run
        if self._event_log:
            await self._event_log.append("runs.Created", {"run_id": run.id})
        return run
```

### A.6 Files to Change

| File | Changes |
|------|---------|
| `src/events/types.py` | Add `orders.Created` |
| `src/veda/orders/repository.py` | Use context managers |
| `src/glados/dependencies.py` | Add all dependency functions |
| `src/glados/app.py` | Ensure all services in app.state |
| `src/glados/routes/runs.py` | Use Depends() |
| `src/glados/routes/orders.py` | Use Depends(), wire VedaService |
| `src/glados/routes/candles.py` | Use Depends() |
| `src/glados/routes/sse.py` | Use Depends() |
| `src/glados/services/run_manager.py` | Accept EventLog, emit events |

---

## Part B: MVP Execution Plan

### MVP-1: Trivial Fixes (~30 min)

**Tasks**:
1. Add `CREATED = "orders.Created"` to `OrderEvents` in `src/events/types.py`
2. Fix `OrderRepository` methods to use `async with self._session_factory() as session:`
3. Either use or remove `RunNotStartableError` / `RunNotStoppableError`

**Tests**: Run existing tests, should all pass.

### MVP-2: Dependencies Module (~1 hour)

**Tasks**:
1. Rewrite `src/glados/dependencies.py` with all getters
2. Update `app.py` lifespan to ensure all services are in `app.state`
3. Add `RunManager` to app.state (currently only created in routes)

**Tests**: Add tests for dependency functions.

### MVP-3: Routes Migration (~2 hours)

**Tasks**:
1. Update `routes/runs.py` to use `Depends(get_run_manager)`
2. Update `routes/orders.py` to use `Depends(get_veda_service)`
3. Update `routes/candles.py` to use `Depends(get_market_data_service)`
4. Update `routes/sse.py` to use `Depends(get_broadcaster)`
5. Remove all module-level `_service` singletons and `get_*()` functions

**Tests**: All existing route tests should still pass.

### MVP-4: Event Emission (~2 hours)

**Tasks**:
1. Add `event_log` parameter to `RunManager.__init__()`
2. Emit `runs.Created` in `create()`
3. Emit `runs.Started` in `start()`
4. Emit `runs.Stopped` in `stop()`
5. Update app.py to pass EventLog to RunManager

**Tests**: Add tests verifying events are emitted.

### MVP-5: Integration Verification (~1 hour)

**Tasks**:
1. Manual test: Create run via API → verify SSE receives event
2. Add integration test for full flow
3. Update M4 entry gate checklist

**Tests**: New integration test for event flow.

---

## Success Criteria

- [ ] All routes use `Depends()` from `dependencies.py`
- [ ] No module-level service singletons remain
- [ ] `runs.Created` event emitted on POST /runs
- [ ] SSE client receives events from EventLog
- [ ] All 493+ tests still passing
- [ ] No new test failures

---

## Test Specifications

### MVP-2 Tests

```python
# tests/unit/glados/test_dependencies.py

class TestGetRunManager:
    def test_returns_run_manager_from_app_state(self, app):
        request = MockRequest(app)
        manager = get_run_manager(request)
        assert manager is app.state.run_manager

class TestGetVedaService:
    def test_returns_veda_service_from_app_state(self, app):
        request = MockRequest(app)
        service = get_veda_service(request)
        assert service is app.state.veda_service
```

### MVP-4 Tests

```python
# tests/unit/glados/services/test_run_manager.py

class TestRunManagerEventEmission:
    async def test_create_emits_runs_created_event(self, event_log):
        manager = RunManager(event_log=event_log)
        run = await manager.create(RunCreate(...))
        
        events = await event_log.read(0, 10)
        assert len(events) == 1
        assert events[0].type == "runs.Created"
        assert events[0].payload["run_id"] == run.id
```

---

*Created: 2026-02-02*
