# Deployment & Operations

> Part of [Architecture Documentation](../ARCHITECTURE.md)
>
> **Document Charter**  
> **Primary role**: deployment topology and operational procedures.  
> **Authoritative for**: container setup, environment/secrets delivery, migration operations.  
> **Not authoritative for**: API/event schema or milestone status.

## 1. Container Topology

- **Backend**: single-stage Dockerfile (`docker/backend/Dockerfile`), production target runs uvicorn directly.
- **Dev Backend**: separate `Dockerfile.dev` with Node.js and debug tooling.
- **Frontend**: multi-stage Dockerfile (`docker/frontend/Dockerfile`): `builder` compiles React → `nginx:alpine` serves static assets.
- **Compose**: `docker-compose.yml` (production) + `docker-compose.dev.yml` (development with hot-reload).

## 2. Environment Variables & Secrets

- **Template in repo**: `docker/example.env` (unified template for all environments).
- **Local file**: `docker/.env` is auto-generated by `docker/init-env.sh` and **not committed** (`.gitignore`).
- **Initialization**: `init-env.sh` runs as devcontainer `initializeCommand`, creating `.env` from template and injecting any secrets from Codespaces/GitHub environment variables.
- **Build‑time args**: non‑secrets only (e.g., `VITE_API_BASE`).
- **Run‑time secrets**: DB/exchange keys injected by the deployment system; **never baked into image layers**.
- **CI build‑time private sources**: use **BuildKit Secrets** (ephemeral mounts, no layer leakage).

### Database Environment Variables

| Variable             | Description                                     | Example                    |
| -------------------- | ----------------------------------------------- | -------------------------- |
| `POSTGRES_DB`        | Database name                                   | `weaverdb`                 |
| `POSTGRES_USER`      | Database user                                   | `weaver`                   |
| `POSTGRES_PASSWORD`  | Database password                               | `secret`                   |
| `POSTGRES_PORT_PROD` | Host port mapping (prod)                        | `25432`                    |
| `POSTGRES_PORT_DEV`  | Host port mapping (dev)                         | `15432`                    |
| `DB_URL`             | Full connection URL (auto-generated by compose) | `postgresql+asyncpg://...` |

**Note**: `DB_URL` is constructed by docker-compose from the above variables. The internal container port is always `5432`.

## 3. Migrations

- Use **Alembic** from day one; run `alembic upgrade head` before release.
- Migrations live in `src/walle/migrations/versions/`.
- `env.py` reads `DB_URL` from environment (falls back to `alembic.ini` default).
- Alembic uses sync driver (`psycopg2`), app uses async driver (`asyncpg`).

```bash
# Run migrations
alembic upgrade head

# Rollback
alembic downgrade -1

# Generate new migration
alembic revision --autogenerate -m "description"
```

## 4. Operations & Reliability

- **Backpressure**: throttle based on `consumer_offsets` lag thresholds.
- **Rate limiting**: live access coordinated by GLaDOS (DB token bucket/quotas).
- **Observability**: structured logs (include `run_id / corr_id`); optional metrics for lag/in‑flight/error rates.
- **Idempotency & Recovery**: event dedupe (`id/corr_id`); `client_order_id` on orders; consumers resume via offsets; outbox is replayable.

### 4.1 Degraded Mode Matrix (DB On vs DB Off)

| Capability                                                                      | DB On                                                      | DB Off                                          |
| ------------------------------------------------------------------------------- | ---------------------------------------------------------- | ----------------------------------------------- |
| `GET /api/v1/healthz`                                                           | ✅ available                                               | ✅ available                                    |
| `GET/POST /api/v1/runs`, `GET /api/v1/runs/{id}`, `POST /api/v1/runs/{id}/stop` | ✅ available (in-memory run store + event log integration) | ✅ available (in-memory only, non-durable)      |
| `POST /api/v1/orders`, `DELETE /api/v1/orders/{id}`                             | ✅ available when `VedaService` is configured              | ❌ `503` (`VedaService` not configured)         |
| `GET /api/v1/orders`, `GET /api/v1/orders/{id}`                                 | ✅ available (`VedaService` first, fallback to mock path)  | ✅ available (mock read path)                   |
| `GET /api/v1/events/stream` connection                                          | ✅ available                                               | ✅ available                                    |
| Run/order domain events delivered to SSE                                        | ✅ best-effort real-time (DB event log path)               | ⚠️ not guaranteed; no durable event log/offsets |
| Offset durability / replay primitives                                           | ✅ `consumer_offsets` persistence                          | ❌ unavailable                                  |

**Operational decision**: no-DB mode is a degraded local mode for API bring-up and non-durable smoke usage, not a production reliability profile.

## 5. Versioning & Compatibility

- **Additive changes are backward‑compatible**; breaking changes use new names like `*.v2` and run in parallel for migration.
- **Pluggable implementation**: if LISTEN/NOTIFY is insufficient, swap `events/log.py` for Redis Streams/Kafka; protocol and business code remain unchanged.
- **Decomposition**: modules can be split into separate processes if needed, reusing the same protocol and offsets semantics.

## 6. Repository Structure

```plaintext
weaver/
├── README.md
├── pyproject.toml                     # tooling config
├── docker/
│   ├── backend/
│   │   ├── Dockerfile                 # multi-stage dev/prod
│   │   ├── requirements.txt           # runtime deps
│   │   └── requirements.dev.txt       # dev deps
│   ├── example.env                    # unified env template
│   ├── init-env.sh                    # auto-generates .env from template
│   ├── docker-compose.yml             # production-like
│   └── docker-compose.dev.yml         # dev overrides
├── src/
│   ├── glados/                        # Control plane & API
│   ├── events/                        # Event protocol & log
│   ├── veda/                          # Live data & trading
│   ├── greta/                         # Backtest simulation
│   ├── marvin/                        # Strategy execution
│   ├── walle/                         # Persistence layer
│   │   ├── database.py                # Async session factory
│   │   ├── models.py                  # SQLAlchemy 2.0 models
│   │   └── migrations/                # Alembic migrations
│   │       ├── env.py
│   │       ├── script.py.mako
│   │       └── versions/
│   └── config.py                      # Configuration
├── alembic.ini                        # Alembic config (project root)
├── haro/                              # React frontend (TBD)
├── tests/
│   ├── unit/
│   ├── integration/                   # Requires DB_URL
│   └── e2e/
└── docs/
    └── architecture/
```
